# Modify NPK

This tool takes in a valid NPK and a squashfs filesystem. It finds the squashfs section in the NPK and overwrites it with the provided squashfs. As you might know, MikroTik signs (or something) their NPK. So all we've done is made an invalid package, right?

Wrong. In RouterOS before 6.42, an attacker that obtains root (see Cleaner Wrasse) can overwrite any of the NPK in /var/pdb/ with the NPK generated by this tool (or just create a new /var/pdb directory to put it in). After a reboot, *RouterOS will have installed your NPK, bad signature be damned!* 

It appears, before 6.42, RouterOS didn't validate the signature of the package after it made it to /var/pdb. This allows an attack to introduce their own package, or ovewrite any package... overall its quite sneaky.

Thankfully this did get patched, but no specific release note seems to cover this case.

## How do I create the squashfs file?

Great question! I do this:

```sh
mksquashfs ./_1000.squashfs.extracted/squashfs-root/ lol.squashfs -comp xz -b 262144 -all-root
```
## Whoah buddy. This is complicated. Is there any sample usage?

Sure!

```sh
albinolobster@ubuntu:~/routeros/modify_npk/build$ ./modify_npk -n wrasse -s ~/packages/6.41.4/_dude-6.41.4.npk.extracted/wrasse.squashfs -f ~/packages/6.41.4/dude-6.41.4.npk 
albinolobster@ubuntu:~/routeros/modify_npk/build$ ls -l wrasse.npk 
-rw-r--r-- 1 albinolobster albinolobster 8273 Aug 13 17:00 wrasse.npk
```

## Are there side affects?

Uhm... not really. Its pretty sweet.

## What are the build dependencies?

This requires:

* Boost 1.66 or higher
* cmake

## How do I build this jawn?

Just normal cmake. Try this:

```sh
mkdir build
cd build
cmake ..
make
```

Resolve dependencies as needed.
